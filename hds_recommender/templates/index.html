<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Health Data Science Course Recommendation</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

  <!-- CSS Variables & Styles -->
  <style>
    :root {
      --primary: #6f42c1;
      --primary-light: #a684e2;
      --bg: #f8f6fb;
      --text-dark: #333;
    }
    body {
      background: var(--bg);
      color: var(--text-dark);
      font-family: 'Lato', sans-serif;
    }
    h1.page-title {
      text-align: center;
      font-family: 'Playfair Display', serif;
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 2rem;
    }
    .navbar, .table thead th {
      background: var(--primary) !important;
      color: #fff !important;
    }
    .course-link {
      color: var(--primary);
      cursor: pointer;
      transition: color .2s;
    }
    .course-link:hover {
      color: var(--primary-light);
      text-decoration: underline;
    }
    .btn-primary {
      background: var(--primary-light);
      border-color: var(--primary-light);
      transition: background .2s, transform .2s, box-shadow .2s;
    }
    .btn-primary:hover {
      background: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn-recommend {
      display: inline-block;
      background: linear-gradient(45deg,#6f42c1,#a684e2);
      color: #fff;
      border: none;
      border-radius: 50px;
      padding: .75rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      transition: transform .2s, box-shadow .2s;
    }
    .btn-recommend:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .btn-recommend-outline {
      display: inline-block;
      background: transparent;
      color: var(--primary);
      border: 2px solid var(--primary);
      border-radius: 50px;
      padding: .75rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      transition: background .2s, color .2s, transform .2s, box-shadow .2s;
    }
    .btn-recommend-outline:hover {
      background: var(--primary-light);
      color: #fff;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }
    .card {
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: 8px;
      transition: transform .2s, box-shadow .2s;
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
  </style>

  <!-- AOS / Bootstrap / DataTables CSS -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">
        <img src="{{ logo_url }}" height="50" class="me-2" alt="Logo">
      </a>
    </div>
  </nav>

  <!-- Page Title -->
  <h1 class="page-title">Health Data Science Course Recommendation</h1>

  <div class="container">

    <!-- Intro -->
    <div class="text-center mb-5" data-aos="fade-up">
      This system supports <strong>Popularity</strong>, <strong>Association Rules (AR)</strong>, 
      <strong>Collaborative Filtering (CF)</strong>, and <strong>Hybrid</strong>.<br>
      Based on Manchester University Health Data Science enrolment data, it recommends your best electives.
    </div>

    <!-- 1. Course & Ratings Table -->
    <h2 class="mb-2" data-aos="fade-up">Course Catalog & Ratings</h2>
    <p class="fst-italic text-muted small" data-aos="fade-up">
      * Courses marked <span class="badge bg-warning text-dark">NEW*</span> are introduced in 2026. Ratings on a 1–5 scale.
    </p>
    <div class="table-responsive mb-4" data-aos="fade-up">
      <table id="grading-table" class="table table-bordered table-striped align-middle">
        <thead>
          <tr>
            <th>Title</th>
            <th>Code</th>
            <th>Exam</th>
            <th>Average Rating</th>
            <th>Average Satisfaction</th>
          </tr>
        </thead>
        <tbody>
          {% for row in grading_forms %}
          <tr>
            <td>
              <a class="course-link" data-code="{{ row.Code }}">{{ row.Title }}</a>
            </td>
            <td>
              {{ row.Code }}
              {% if row.Code in new_courses %}
                <span class="badge bg-warning text-dark">NEW*</span>
              {% endif %}
            </td>
            <td>{{ row.Exam or 'N/A' }}</td>
            <td>{{ row['Average Rating'] or 'N/A' }}</td>
            <td>{{ row['Average Satisfaction'] or 'N/A' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- 2. Yearly Chart (before Metric Explanation) -->
    <div class="mb-3 text-center" data-aos="fade-up">
      <label for="year-select" class="form-label me-2">Select Year:</label>
      <select id="year-select" class="form-select d-inline-block w-auto">
        {% for y in years %}
          <option value="{{ y }}">{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-4 text-center" data-aos="fade-up">
      <canvas id="year-chart"
              style="display:block; margin:0 auto; max-width:600px; width:100%; height:350px;">
      </canvas>
    </div>

    <!-- 3. Metric Explanation -->
    <div class="alert alert-light border-start border-4 mb-4" style="border-color:var(--primary)" data-aos="fade-up">
      <strong>Metric Explanation:</strong>
      <ul class="mb-0">
        <li><strong>AR:</strong> Association Rules confidence.</li>
        <li><strong>CF:</strong> Collaborative Filtering similarity.</li>
      </ul>
      Final = weighted AR + CF.
    </div>

    <!-- 4. Selection & Strategy -->
    <div class="row g-3 mb-4" data-aos="fade-up">
      <div class="col-md-6">
        <label class="form-label">Selected Courses:</label>
        <ul id="selected-courses" class="list-group mb-2"></ul>
        <button id="reset-btn" class="btn btn-outline-secondary btn-sm">Reset</button>
      </div>
      <div class="col-md-6">
        <label class="form-label">Strategy:</label>
        <select id="mode-select" class="form-select mb-2">
          <option value="support">Popularity</option>
          <option value="ar">Association Rules (AR)</option>
          <option value="cf">Collaborative Filtering (CF)</option>
          <option value="hybrid" selected>Hybrid (AR+CF)</option>
        </select>
        <label class="form-label">Add Course:</label>
        <div class="input-group">
          <select id="course-dropdown" class="form-select">
            <option disabled selected>— Select Course —</option>
            {% for code, title in course_meta_dict.items() %}
              <option value="{{ code }}">{{ code }} — {{ title }}</option>
            {% endfor %}
          </select>
          <button id="add-course-btn" class="btn btn-primary btn-sm">Add</button>
        </div>
      </div>
    </div>

    <!-- 5. Recommendations -->
    <h2 class="mb-2" data-aos="fade-up">Recommendations</h2>
    <div class="row row-cols-1 row-cols-md-3 g-4 mb-5" id="recommend-cards"></div>

    <!-- 6. Bottom Controls -->
    <div class="text-center mb-5" data-aos="fade-up">
      <button id="get-recommend-btn" class="btn-recommend me-3">Get Recommendations</button>
      <button id="export-btn" class="btn-recommend-outline">Export PDF</button>
    </div>

  </div>

  <!-- Course Detail Modal -->
  <div class="modal fade" id="courseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background:var(--primary); color:#fff;">
          <h5 class="modal-title" id="courseModalLabel"></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"></div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="py-3 bg-white text-center text-muted mt-5" data-aos="fade-up">
    &copy; 2025 Manchester University — Health Data Science
  </footer>

  <!-- JS Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // 初始化 AOS
    AOS.init({ duration: 600, once: true });

    // jsPDF 构造器
    const { jsPDF } = window.jspdf;

    // 后端注入的新课列表
    const newCourses = {{ new_courses|tojson|safe }};

    // 保存最近一次推荐结果
    let lastRecs = [];

    // Course Detail Modal 实例
    const courseModal = new bootstrap.Modal(document.getElementById('courseModal'));

    // 课程详情对象（请在此处粘入你完整的 courseDetails 对象，确保每个条目之间用逗号隔开，最后一条没有逗号）
    const courseDetails = {
      "IIDS69052": {
        title: "IIDS69052 – Digital Epidemiology",
        sections: [
          { heading: "Short description", content: "Explores the use of digital data sources—social media, search engines, mobile apps, wearables, EHRs—for real-time public-health surveillance, biomarker discovery, and intervention design." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2", "≈150 hours independent study"] },
          { heading: "Prerequisites", content: "No formal prerequisites; basic statistics and data-processing skills recommended." },
          { heading: "Delivery format", list: ["In-person lectures", "E-learning reading materials", "Group-based assignment", "Individual assignment"] },
          { heading: "Assessment", list: ["Group project presentation (10 min + 5 min Q&A): 40%", "Individual written report (400-word scientific abstract + 300-word lay abstract): 60%"] },
          { heading: "Key learning outcomes", list: ["Identify and integrate diverse digital data sources for epidemiological research", "Compare strengths, limitations, and biases of digital vs. traditional epidemiology", "Apply data-cleaning, validation, and large-scale analytics techniques", "Evaluate ethical, legal, and privacy considerations in digital-health data use"] },
          { heading: "Recommended reading", content: "Walker, M. (2022). Digital Epidemiology: An Introduction to Disease Surveillance Using Digital Data." },
          { heading: "Teaching staff", content: "Ian Hall · William Dixon · Victoria Palin" }
        ]
      },
      "IIDS60542": {
        title: "IIDS60542 – Introduction to Health Informatics",
        sections: [
          { heading: "Short description", content: "An overview of electronic patient records (EPRs), clinical coding schemes (Read codes, SNOMED), and interoperability standards (HL7), together with the human-factors, governance, and usability challenges in e-health systems." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2", "≈130 hours independent study", "10 h lectures + 10 h practicals/workshops"] },
          { heading: "Prerequisites", content: "Principles of Digital Biology (COMP60532)" },
          { heading: "Delivery format", list: ["In-person lectures", "Practical classes & workshops", "Group discussions", "Independent reading"] },
          { heading: "Assessment", list: ["Individual written assignment (essay): 100%"] },
          { heading: "Key learning outcomes", list: ["Understand the development, structure, and challenges of EPRs, including data governance and confidentiality.", "Critically evaluate coding schemes (Read codes, SNOMED) and their maintenance.", "Explain interoperability concepts and messaging standards (e.g. HL7).", "Analyse human-factors and usability issues in e-health implementations.", "Apply qualitative methods to assess organisational change in healthcare settings."] },
          { heading: "Transferable skills", list: ["Interdisciplinary teamwork", "Project management", "Problem solving", "Academic writing & reflection"] },
          { heading: "Teaching staff", content: "Helen Hulme (Unit coordinator)" }
        ]
      },
      "IIDS61402": {
        title: "IIDS61402 – Decision Support Systems",
        sections: [
          { heading: "Short description", content: "Focuses on the representation and use of patient data and clinical knowledge in computational approaches to support healthcare decision making, covering design, evaluation, and integration challenges of clinical decision support (CDS) systems." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2", "≈150 hours independent study"] },
          { heading: "Prerequisites", content: "None specified; recommended background in healthcare data concepts or basic programming." },
          { heading: "Delivery format", list: ["E-learning preparatory materials", "Face-to-face lectures & open discussions", "Problem-based group workshops (1 × 3-day block)", "Case-study analyses"] },
          { heading: "Assessment", list: ["Group presentation: 20%", "Computer practical: 20%", "Individual report: 60%"] },
          { heading: "Key learning outcomes", list: ["Theories of clinical decision making (statistical, psychological, shared decision making)", "Types of CDS (alerts, reminders, computerized guidelines) and their pros/cons", "Methods for knowledge acquisition and modelling", "Application of CDS at patient and population levels", "Design considerations and performance evaluation of CDS"] },
          { heading: "Teaching staff", content: "Niels Peek (Unit coordinator)" }
        ]
      },
      "IIDS67302": {
        title: "IIDS67302 – Introduction to Clinical Bioinformatics",
        sections: [
          { heading: "Short description", content: "Covers the fundamentals of human genomics and bioinformatics in a clinical context, from DNA→RNA→protein biology through next-generation sequencing workflows, variant interpretation, and the ethical/governance framework for genomic data." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2 (6 weeks)", "≈25 h/week (10 h video lectures & readings, 3 h workshops, 2 h discussion forums, 5 h summative case work, 5 h private study)"] },
          { heading: "Prerequisites", content: "None specified; basic molecular biology or introductory genomics recommended." },
          { heading: "Delivery format", list: ["Online video lectures & readings (Articulate Rise)", "Weekly hands-on workshops (clinical case studies in eLab)", "Discussion forums with tutor-facilitated peer learning", "Summative case-study analysis"] },
          { heading: "Assessment", list: ["Individual recorded presentation (10 min, clinical variant analysis): 100%"] },
          { heading: "Key learning outcomes", list: ["Explain DNA/RNA/protein structure & function, genomic variation, and sequencing technologies.", "Navigate primary sequence databases (GenBank, UniProt) and genome browsers (Ensembl, UCSC).", "Apply alignment algorithms (BLAST, Smith–Waterman) and variant annotation tools.", "Integrate bioinformatic resources (variant/phenotype databases, predictive tools) to interpret patient variants.", "Demonstrate workflows for SNV/indel/CNV analysis and report generation.", "Critically discuss data protection, consent, and incidental findings in clinical genomics.", "Communicate complex genomic results clearly in oral and written formats.", "Work independently to analyse clinical case data and reflect on methodology."] },
          { heading: "Recommended reading", list: ["Strachan, T. & Read, A. (2021). Human Molecular Genetics (Garland Science).", "Walker, M. (2022). Digital Epidemiology (for comparative methodology).", "Key papers on variant interpretation standards (e.g. Richards et al., 2015)."] },
          { heading: "Teaching staff", content: "Andrew Devereau · Angela Davies" }
        ]
      },
      "IIDS67462": {
        title: "IIDS67462 – Mathematical Computing for Medical Imaging",
        sections: [
          { heading: "Short description", content: "Introduces mathematical and computational methods—optimization, statistical shape modelling, classification/regression, and neural networks—and their implementation in Python for quantitative analysis of medical images." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2", "≈150 h independent study", "12 × 3 h blended sessions (lectures + problem-solving + in-class programming)"] },
          { heading: "Prerequisites", content: "Basic linear algebra (matrices & vectors) and calculus (derivatives); online refresher materials provided." },
          { heading: "Delivery format", list: ["In-person lectures & live coding/practicals", "Problem-solving exercises at end of each session", "All materials via Blackboard"] },
          { heading: "Assessment", list: ["Two Python programming assignments (20% each; total 40%)", "Written exam (60%)"] },
          { heading: "Key learning outcomes", list: ["Understand core mathematical techniques for image optimisation, modelling, classification, and analysis.", "Select and apply appropriate Python libraries to implement these algorithms.", "Critically evaluate algorithm performance and interpret results.", "Develop practical Python coding skills to build image-analysis pipelines.", "Communicate quantitative findings effectively in writing."] },
          { heading: "Teaching staff", content: "Timothy Cootes (Unit coordinator)" }
        ]
      },
      "IIDS67482": {
        title: "IIDS67482 – Medical Image Analysis and Artificial Intelligence",
        sections: [
          { heading: "Short description", content: "Covers core image-processing techniques (filtering, segmentation, registration) and deep-learning methods (CNNs, representation learning) for medical imaging applications, with hands-on Python exercises." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2", "≈150 h independent study", "12 × 90 min lectures + 60 min practical per week"] },
          { heading: "Prerequisites", content: "Basic Python proficiency; familiarity with linear algebra and calculus recommended." },
          { heading: "Delivery format", list: ["In-person lectures & discussions", "Weekly practical sessions", "Online reading lists & tutorials on Blackboard"] },
          { heading: "Assessment", list: ["Written exam (2.5 h): 70%", "Written assignment (2,000 words): 30%"] },
          { heading: "Key learning outcomes", list: ["Image processing fundamentals: noise models, filtering, region analysis", "Object detection, segmentation, and evaluation metrics", "Image registration: rigid, affine, and deformable methods", "Deep-learning basics and CNN architectures for medical images"] },
          { heading: "Teaching staff", content: "Arezoo Zakeri (Unit coordinator)" }
        ]
      },
      "IIDS67612": {
        title: "IIDS67612 – Tutorials in Advanced Statistics",
        sections: [
          { heading: "Short description", content: "A literature-driven module exploring advanced statistical methods—such as machine learning in clinical prediction, meta-analysis, and longitudinal data analysis—through critical reading, discussion, and debate led by active researchers." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2", "≈116 h independent study", "4 h lectures + 30 h workshops"] },
          { heading: "Prerequisites", content: "Foundational statistical content from Semester 1 modules." },
          { heading: "Delivery format", list: ["Twice-weekly face-to-face sessions for topic introduction and debate", "Literature-based individual and group tasks", "Online capture of sessions and tutor support via Blackboard and office hours", "Interactive tools (e.g. Google Jamboard) for inclusive participation"] },
          { heading: "Assessment", list: ["Individual coursework report (3,000–4,500 words, critical appraisal of research literature): 100%"] },
          { heading: "Teaching staff", content: "Jamie Christopher Sergeant (Unit coordinator)" }
        ]
      },
      "IIDS67682": {
        title: "IIDS67682 – Machine Learning and Advanced Data Methods",
        sections: [
          { heading: "Short description", content: "Covers the application of machine learning and advanced computational approaches to high-throughput biological experiments and patient-level health data, with hands-on Python pipelines." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2 (6 days of face-to-face teaching)", "≈100 h independent study", "25 h practicals/workshops + 25 h tutorials"] },
          { heading: "Prerequisites", content: "No formal prerequisites; recommended background in Python programming and basic statistics." },
          { heading: "Delivery format", list: ["Face-to-face lectures & open discussions", "Practical coding sessions in Jupyter notebooks via Blackboard", "Real-world dataset exercises"] },
          { heading: "Assessment", list: ["Three interactive online assessments (via Jupyter notebooks), covering: 1. Exploratory data analysis; 2. Supervised machine learning; 3. Advanced topics (neural networks & ethics)"] },
          { heading: "Key learning outcomes", list: ["Critically explain advanced machine learning methods and when to apply them", "Evaluate ethical implications of ML on biomedical datasets", "Build end-to-end Python data-analysis pipelines", "Perform EDA, clustering, and algorithm performance evaluation"] }
        ]
      },
      "IIDS67692": {
        title: "IIDS67692 – Computational Methods for Multi-Modal Data Analysis",
        sections: [
          { heading: "Short description", content: "Covers methods to integrate and analyse multi-modal health data (omics, imaging, clinical records) using machine-learning and statistical techniques, with hands-on computational workflows." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2 (6 weeks)", "≈115 h independent study", "17 h lectures + 18 h practicals/workshops"] },
          { heading: "Prerequisites", content: "Recommended background in Python programming, statistics, and basic familiarity with omics or imaging data." },
          { heading: "Delivery format", list: ["Blended learning: online lectures + F2F tutorials", "Formative group activities during workshops", "Jupyter-based programming exercises"] },
          { heading: "Assessment", content: "Summative programming exercise (Jupyter notebook analysis + report): 100% (with written feedback within 15 days)" },
          { heading: "Key learning outcomes", list: ["Describe multi-modal data types (bulk & single-cell omics, spatial omics, imaging, EHRs)", "Explain challenges in data integration and case-study applications", "Critically evaluate computational methods for multi-modal integration", "Develop ML/AI pipelines for omics and imaging integration", "Collaborate across computational and clinical teams"] },
          { heading: "Teaching staff", content: "Juhi Gupta · Sokratia Georgaka" }
        ]
      },
      "IIDS68112": {
        title: "IIDS68112 – Design and Analysis of Randomised Controlled Trials",
        sections: [
          { heading: "Short description", content: "Introduces the statistical principles and methods for designing, conducting, and analysing randomised controlled trials (RCTs), including bias control, allocation methods, sample-size estimation, and intention-to-treat analysis using R." },
          { heading: "Credits & study load", list: ["15 credits", "Semester 2 (11 weeks)", "≈1.25 h/week online lectures + exercises", "Group tutorials and review sessions", "One revision week"] },
          { heading: "Prerequisites", content: "Basic statistical knowledge (e.g. from Semester 1 modules); familiarity with R is helpful." },
          { heading: "Delivery format", list: ["Blended learning: online lecture materials + face-to-face review and tutorials", "Group exercises on RCT design & analysis", "R-based practical sessions"] },
          { heading: "Assessment", list: ["Written exam (60%)", "Written assignment (essay on RCT design/critique; 40%)"] },
          { heading: "Key learning outcomes", list: ["Select and apply appropriate statistical methods for various RCT designs", "Control and assess bias (blinding, allocation, intention-to-treat)", "Analyse RCT data in R, including baseline adjustment and handling protocol deviations", "Conduct meta-analysis of multiple RCTs"] }
        ]
      }
    };

    // DataTable
    $('#grading-table').DataTable({
      paging: false,
      info: false,
      searching: false,
      ordering: true
    });

    // —— 年度柱状图 —— 
    const yearCourseCounts = {{ year_course_counts_json|safe }};
    const yearSel = document.getElementById('year-select');
    let currentYear = yearSel.value;
    const ctx = document.getElementById('year-chart').getContext('2d');
    const yearChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: Object.keys(yearCourseCounts[currentYear]),
        datasets: [{
          label: `Enrollments in ${currentYear}`,
          data: Object.values(yearCourseCounts[currentYear]),
          backgroundColor: 'rgba(111,66,193,0.6)',
          borderColor: 'rgba(111,66,193,1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        onClick(evt, items) {
          if (items.length) {
            const idx = items[0].index;
            const code = this.data.labels[idx];
            const cnt  = this.data.datasets[0].data[idx];
            alert(`${code} had ${cnt} enrollments in ${currentYear}`);
          }
        },
        scales: {
          x: { title: { display: true, text: 'Course Code' } },
          y: { beginAtZero: true, title: { display: true, text: 'Count' } }
        }
      }
    });
    yearSel.addEventListener('change', function() {
      currentYear = this.value;
      const dataObj = yearCourseCounts[currentYear];
      yearChart.data.labels = Object.keys(dataObj);
      yearChart.data.datasets[0].data = Object.values(dataObj);
      yearChart.data.datasets[0].label = `Enrollments in ${currentYear}`;
      yearChart.update();
    });

    // —— 推荐 & 导出 PDF 逻辑 —— 
    let selected = [], maxSel = 4;

    function fetchRecommendations() {
      const numMap = [4,3,2,1];
      const num = numMap[selected.length] || 4;
      $.ajax({
        url: '/recommend',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
          selected,
          num_rec: num,
          mode: $('#mode-select').val()
        })
      }).done(resp => {
        lastRecs = resp.recommendations || [];
        const $row = $('#recommend-cards').empty();
        lastRecs.forEach(r => {
          const badge = newCourses.includes(r.code)
            ? '<span class="badge bg-warning text-dark ms-1">NEW*</span>' : '';
          $row.append(`
            <div class="col" data-aos="zoom-in" data-code="${r.code}">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">${r.code}${badge}</h5>
                  <p class="card-text">${r.title}</p>
                  <p>
                    <span class="badge bg-info me-1">Pop ${r.support.toFixed(4)}</span>
                    <span class="badge bg-success me-1">AR ${(r.ar_score||0).toFixed(4)}</span>
                    <span class="badge bg-warning text-dark">CF ${(r.cf_score||0).toFixed(4)}</span>
                  </p>
                  <p class="fw-bold">Final ${(r.final_score||0).toFixed(4)}</p>
                </div>
              </div>
            </div>
          `);
        });
      });
    }

    function addToSelected(code) {
      if (!code) return alert("Please select a course.");
      if (selected.includes(code)) return;
      if (selected.length >= maxSel) return alert("Max 4 courses.");
      selected.push(code);
      $('#selected-courses').append(`
        <li class="list-group-item d-flex justify-content-between align-items-center" data-code="${code}">
          ${code}
          <button class="btn btn-sm btn-outline-danger remove-course-btn">Remove</button>
        </li>
      `);
      fetchRecommendations();
    }

    $(function(){
      // 课程详情弹窗
      $('#grading-table').on('click', '.course-link', function(){
        const code = $(this).data('code');
        const info = courseDetails[code];
        if (!info) return alert("No details.");
        $('#courseModalLabel').text(info.title);
        const $b = $('#courseModal .modal-body').empty();
        info.sections.forEach(sec => {
          $b.append(`<h6>${sec.heading}</h6>`);
          if (sec.content) $b.append(`<p>${sec.content}</p>`);
          if (sec.list) {
            const $ul = $('<ul></ul>');
            sec.list.forEach(i => $ul.append(`<li>${i}</li>`));
            $b.append($ul);
          }
        });
        courseModal.show();
      });

      // Add / Remove / Reset / Recommend / Export
      $('#add-course-btn').click(() => addToSelected($('#course-dropdown').val()));
      $('#recommend-cards').on('click', '.card', function(){
        addToSelected($(this).closest('[data-code]').data('code'));
      });
      $('#selected-courses').on('click', '.remove-course-btn', function(){
        const li = $(this).closest('li');
        const code = li.data('code');
        selected = selected.filter(c => c !== code);
        li.remove();
        fetchRecommendations();
      });
      $('#reset-btn').click(() => {
        selected = [];
        $('#selected-courses').empty();
        $('#recommend-cards').empty();
      });
      $('#get-recommend-btn').click(fetchRecommendations);
      $('#export-btn').click(() => {
        if (!lastRecs.length) return alert("No recommendations.");
        html2canvas(document.querySelector('#recommend-cards')).then(canvas => {
          const img = canvas.toDataURL('image/png');
          const pdf = new jsPDF('p','pt','a4');
          const w = pdf.internal.pageSize.getWidth();
          const h = canvas.height * w / canvas.width;
          pdf.addImage(img,'PNG',0,0,w,h);
          pdf.save('recommendations.pdf');
        });
      });
    });
  </script>
</body>
</html>
